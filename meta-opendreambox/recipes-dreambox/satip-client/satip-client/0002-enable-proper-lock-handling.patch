From 1234b4e8ec91af2be401e226ed5c228ff1f9058a Mon Sep 17 00:00:00 2001
From: Stephan Reichholf <reichi@opendreambox.org>
Date: Thu, 9 Feb 2017 21:53:52 +0100
Subject: [PATCH 2/2] enable proper lock handling

---
 rtp.cpp    | 13 +++++++++----
 rtp.h      |  1 +
 vtuner.cpp | 22 ++++++++++++++--------
 vtuner.h   | 12 +++++++++++-
 4 files changed, 35 insertions(+), 13 deletions(-)

diff --git a/rtp.cpp b/rtp.cpp
index 95cd3d4..c4d00c0 100644
--- a/rtp.cpp
+++ b/rtp.cpp
@@ -43,7 +43,7 @@ satipRTP::satipRTP(int vtuner_fd)
 						m_rtcp_socket(-1),
 						m_thread(0),
 						m_running(false),
-						m_hasLock(true),
+						m_hasLock(false),
 						m_signalStrength(0),
 						m_signalQuality(0),
 						m_openok(false)
@@ -67,6 +67,13 @@ satipRTP::~satipRTP()
 		close(m_rtp_socket);
 }
 
+void satipRTP::unset()
+{
+	m_signalStrength = 0;
+	m_hasLock = false;
+	m_signalQuality = 0;
+}
+
 int satipRTP::openRTP()
 {
 	int rtp_sock;
@@ -154,9 +161,7 @@ void satipRTP::parseRtcpAppPayload(char *buffer)
 		quality (Signal quality) : Numerical value between 0 and 15
 	*/
 
-	m_signalStrength = 0;
-	m_hasLock = false;
-	m_signalQuality = 0;
+	unset();
 
 	char *strp = strstr(buffer, ";tuner=");
 	if (strp)
diff --git a/rtp.h b/rtp.h
index 7114bc4..8995b38 100644
--- a/rtp.h
+++ b/rtp.h
@@ -48,6 +48,7 @@ class satipRTP
 public:
 	satipRTP(int vtuner_fd);
 	virtual ~satipRTP();
+	void unset();
 	int get_rtp_port() { return m_rtp_port; }
 	int get_rtp_socket() { return m_rtp_socket; }
 	int get_rtcp_port() { return m_rtcp_port; }
diff --git a/vtuner.cpp b/vtuner.cpp
index 5291cb6..b1fcb52 100644
--- a/vtuner.cpp
+++ b/vtuner.cpp
@@ -497,14 +497,10 @@ void satipVtuner::vtunerEvent()
 
 		case MSG_READ_STATUS:
 			//INFO(MSG_MAIN,"MSG_READ_STATUS\n");
-//				if (m_satip_rtp)
-//				{
-//					if (m_satip_rtp->getHasLock())
-//						msg.body.status = FE_HAS_LOCK;
-//					else
-//						msg.body.status = 0;
-//				}
-			msg.body.status = FE_HAS_LOCK;
+			if (m_satip_rtp && m_satip_rtp->getHasLock())
+				msg.body.status = FE_HAS_LOCK;
+			else
+				msg.body.status = 0;
 			break;
 		case MSG_READ_BER:
 			//INFO(MSG_MAIN,"MSG_READ_BER\n");
@@ -559,6 +555,16 @@ void satipVtuner::vtunerEvent()
 			DEBUG(MSG_MAIN,"MSG_GET_PROPERTY\n");
 			break;
 
+		case MSG_GET_TUNE_SETTINGS:
+			DEBUG(MSG_MAIN,"MSG_GET_TUNE_SETTINGS\n");
+			if (m_satip_rtp) {
+				m_satip_rtp->unset();
+			}
+			msg.body.tune_settings.min_delay_ms = 50; // let linux-tv api ask every 50ms for locked/unlocked state...
+			msg.body.tune_settings.step_size = 0;
+			msg.body.tune_settings.max_drift = 0;
+			break;
+
 		default:
 			DEBUG(MSG_MAIN,"MSG_UNKNOWN: %d\n", msg.type);
 			break;
diff --git a/vtuner.h b/vtuner.h
index 33db6c5..990dec4 100644
--- a/vtuner.h
+++ b/vtuner.h
@@ -45,6 +45,7 @@
 #define MSG_TYPE_CHANGED			15
 #define MSG_SET_PROPERTY			16
 #define MSG_GET_PROPERTY			17
+#define MSG_GET_TUNE_SETTINGS		18
 
 #define MSG_NULL				1024
 #define MSG_DISCOVER			1025
@@ -54,12 +55,20 @@ typedef unsigned int   u32;
 typedef unsigned short u16;
 typedef unsigned char  u8;
 
+struct dvb_frontend_tune_settings
+{
+	int min_delay_ms;
+	int step_size;
+	int max_drift;
+};
+
 #if VMSG_TYPE1
 struct vtuner_message {
 	__u32 type;
 	union 
 	{
-        struct dvb_frontend_parameters fe_params;
+		struct dvb_frontend_parameters fe_params;
+		struct dvb_frontend_tune_settings tune_settings;
 
 #if DVB_API_VERSION >= 5
 		struct dtv_property prop;
@@ -117,6 +126,7 @@ struct vtuner_message
                 } vsb;
             } u;
         } fe_params;
+		struct dvb_frontend_tune_settings tune_settings;
         struct dtv_property prop;
         u32 status;
         __u32 ber;
-- 
2.7.4

