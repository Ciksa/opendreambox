From 559c09c64bf422c7f8d79ea785884237c2d34191 Mon Sep 17 00:00:00 2001
From: Andreas Monzner <andreas.monzner@dream-property.net>
Date: Thu, 30 Aug 2012 14:55:49 +0200
Subject: [PATCH] removed squashfs debug output, more flexible handling for
 removal of temporary opkg files

---
 usr/lib/enigma2/python/Components/Ipkg.py          |   38 ++++++++++++++++----
 .../SystemPlugins/SoftwareManager/plugin.py        |    1 -
 2 files changed, 32 insertions(+), 7 deletions(-)

diff --git a/usr/lib/enigma2/python/Components/Ipkg.py b/usr/lib/enigma2/python/Components/Ipkg.py
index 57dcbf8..488d55e 100644
--- a/usr/lib/enigma2/python/Components/Ipkg.py
+++ b/usr/lib/enigma2/python/Components/Ipkg.py
@@ -2,6 +2,14 @@ from enigma import eConsoleAppContainer
 from glob import glob
 from os import unlink
 
+def erase(name):
+	try:
+		unlink(name)
+		return True
+	except:
+		pass
+	return False
+
 class IpkgComponent:
 	EVENT_INSTALL = 0
 	EVENT_DOWNLOAD = 1
@@ -33,12 +41,30 @@ class IpkgComponent:
 			self.cleanupPackageData()
 
 	def cleanupPackageData(self):
-		for f in glob("/var/tmp/remote-*"):
-			print "IpkgComponent unlink", f
-			unlink(f)
-		for f in glob("/var/lib/opkg/remote-*"):
-			print "IpkgComponent unlink", f
-			unlink(f)
+		list_dirs = [ ]
+		feed_names = [ ]
+		for name in glob("/etc/opkg/*.conf"):
+			f = open(name)
+			for line in f.readlines():
+				try:
+					if line.startswith('lists_dir'):
+						lists_dir = line.split(' ')[2].rstrip('\n\t ')
+						if not lists_dir in list_dirs:
+							list_dirs.append(lists_dir)
+					elif line.startswith('src'):
+						feed_name = line.split(' ')[1]
+						if not feed_name in feed_names:
+							feed_names.append(feed_name)
+				except:
+					print 'IpkgComponent error parsing', name, 'line', line.rstrip('\n\t ')
+			f.close()
+		if not '/var/lib/opkg' in list_dirs:
+			list_dirs.append('/var/lib/opkg')
+		for feed in feed_names:
+			for list_dir in list_dirs:
+				path = list_dir + '/' + feed
+				if erase(path):
+					print 'IpkgComponent erased', path
 		self.update_done = False
 
 	def setCurrentCommand(self, command = None):
diff --git a/usr/lib/enigma2/python/Plugins/SystemPlugins/SoftwareManager/plugin.py b/usr/lib/enigma2/python/Plugins/SystemPlugins/SoftwareManager/plugin.py
index bfcccf3..87f4908 100644
--- a/usr/lib/enigma2/python/Plugins/SystemPlugins/SoftwareManager/plugin.py
+++ b/usr/lib/enigma2/python/Plugins/SystemPlugins/SoftwareManager/plugin.py
@@ -498,7 +498,6 @@ def pendingSqshImgInstall():
 	if sqsh_re is None:
 		sqsh_re = re_compile('^\.u*mount_.+_needed$')
 	for f in listdir('/var/tmp'):
-		print "check ", f
 		if sqsh_re.match(f):
 			return True
 	return False
-- 
1.7.10.4

