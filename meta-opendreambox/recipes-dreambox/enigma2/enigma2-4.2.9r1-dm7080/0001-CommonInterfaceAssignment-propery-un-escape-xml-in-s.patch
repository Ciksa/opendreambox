From c65cd0368263cecdcd238fd918c34e777e8ec81e Mon Sep 17 00:00:00 2001
From: reichi <reichi@opendreambox.org>
Date: Wed, 20 Jan 2016 09:02:03 +0100
Subject: [PATCH 1/3] CommonInterfaceAssignment: propery (un)escape xml in
 save/loadXML methods

---
 .../SystemPlugins/CommonInterfaceAssignment/plugin.py | 19 ++++++++++---------
 1 file changed, 10 insertions(+), 9 deletions(-)

diff --git a/usr/lib/enigma2/python/Plugins/SystemPlugins/CommonInterfaceAssignment/plugin.py b/usr/lib/enigma2/python/Plugins/SystemPlugins/CommonInterfaceAssignment/plugin.py
index ae54997..c27bedb 100644
--- a/usr/lib/enigma2/python/Plugins/SystemPlugins/CommonInterfaceAssignment/plugin.py
+++ b/usr/lib/enigma2/python/Plugins/SystemPlugins/CommonInterfaceAssignment/plugin.py
@@ -4,14 +4,14 @@ from Components.ActionMap import ActionMap
 from Components.Sources.StaticText import StaticText
 from Components.config import config, ConfigNothing
 from Components.ConfigList import ConfigList
-from Components.Label import Label
 from Components.SelectionList import SelectionList
 from ServiceReference import ServiceReference
 from Plugins.Plugin import PluginDescriptor
 from xml.etree.cElementTree import parse as ci_parse
 from enigma import eDVBCI_UI, eDVBCIInterfaces, eEnv, eServiceReference, eServiceCenter
 
-from os import path as os_path, fsync
+from os import path as os_path, unlink as os_unlink, fsync
+from xml.sax.saxutils import escape as xml_escape, unescape as xml_unescape
 
 class CIselectMainMenu(Screen):
 	skin = """
@@ -244,10 +244,12 @@ class CIconfigMenu(Screen):
 					fp.write("\t\t<caid id=\"%s\" />\n" % item[0])
 			for item in self.servicelist:
 				if len(self.servicelist):
+					psname = xml_escape(item[0])
+					psattr = xml_escape(item[3])
 					if item[2]==1:
-						fp.write("\t\t<provider name=\"%s\" dvbnamespace=\"%s\" />\n" % (item[0], item[3]))
+						fp.write("\t\t<provider name=\"%s\" dvbnamespace=\"%s\" />\n" % (psname, psattr))
 					else:
-						fp.write("\t\t<service name=\"%s\" ref=\"%s\" />\n"  % (item[0], item[3]))
+						fp.write("\t\t<service name=\"%s\" ref=\"%s\" />\n"  % (psname, psattr))
 			fp.write("\t</slot>\n")
 			fp.write("</ci>\n")
 			fp.flush()
@@ -255,7 +257,7 @@ class CIconfigMenu(Screen):
 			fp.close()
 		except:
 			print "[CI_Config_CI%d] xml not written" %self.ci_slot
-			os.unlink(self.filename)
+			os_unlink(self.filename)
 
 	def loadXML(self):
 		if not os_path.exists(self.filename):
@@ -284,13 +286,12 @@ class CIconfigMenu(Screen):
 					i+=1
 
 				for service in  slot.findall("service"):
-					read_service_name = service.get("name").encode("UTF-8")
-					read_service_ref = service.get("ref").encode("UTF-8")
+					read_service_ref = xml_unescape( service.get("ref").encode("UTF-8") )
 					self.read_services.append (read_service_ref)
 
 				for provider in  slot.findall("provider"):
-					read_provider_name = provider.get("name").encode("UTF-8")
-					read_provider_dvbname = provider.get("dvbnamespace").encode("UTF-8")
+					read_provider_name = xml_unescape( provider.get("name").encode("UTF-8") )
+					read_provider_dvbname = xml_unescape( provider.get("dvbnamespace").encode("UTF-8") )
 					self.read_providers.append((read_provider_name,read_provider_dvbname))
 
 				self.ci_config.append((int(read_slot), (self.read_services, self.read_providers, self.usingcaid)))
-- 
1.9.1

